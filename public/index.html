<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cosmic Translate | A Conversational Translation Experience</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;500&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    /* ...STYLES... */
  </style>
</head>

<body>
  <div id="starfield"></div>
  <div id="nebula"></div>

  <main class="chat-container">
    <div id="message-list"></div>
    <form id="chat-form">
      <input type="text" id="userInput" placeholder="e.g., Translate 'Hello world' to Spanish" autocomplete="off" />
      <button type="submit" id="sendBtn" title="Send">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>
  </main>

  <script type="module">
    const elements = {
      messageList: document.getElementById('message-list'),
      chatForm: document.getElementById('chat-form'),
      userInput: document.getElementById('userInput'),
      sendBtn: document.getElementById('sendBtn'),
      starfield: document.getElementById('starfield'),
    };

    // --- Setup --- Starfield Background
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.style.position = 'absolute';
      star.style.background = 'white';
      const size = Math.random() * 2 + 1;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.borderRadius = '50%';
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;
      const duration = Math.random() * 5 + 5;
      star.style.animation = `twinkle ${duration}s infinite alternate`;
      star.style.opacity = Math.random() * 0.5 + 0.2;
      elements.starfield.appendChild(star);
    }
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes twinkle { to { opacity: 1; } }`;
    document.head.appendChild(styleSheet);

    // Greet the user
    addMessage("Welcome to Cosmic Translate! How can I help you with a translation today?", 'bot');

    elements.chatForm.addEventListener('submit', handleSendMessage);

    async function handleSendMessage(event) {
      event.preventDefault();
      const userText = elements.userInput.value.trim();
      if (!userText) return;

      addMessage(userText, 'user');
      elements.userInput.value = '';
      elements.sendBtn.disabled = true;

      const thinkingMessageId = `thinking-${Date.now()}`;
      addMessage(`<div class="thinking-indicator"><span></span><span></span><span></span></div>`, 'bot', { id: thinkingMessageId });

      try {
        const response = await fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: userText })
        });

        const data = await response.json();
        const translatedText = data.translated;

        const thinkingMessage = document.getElementById(thinkingMessageId);
        if (thinkingMessage) thinkingMessage.remove();

        addMessage(translatedText, 'bot', { hasCopy: true });

      } catch (error) {
        console.error("Translation Error:", error);
        const thinkingMessage = document.getElementById(thinkingMessageId);
        if (thinkingMessage) thinkingMessage.remove();

        addMessage("API Error. Please check the browser console and verify your API setup.", 'bot', { isError: true });

      } finally {
        elements.sendBtn.disabled = false;
        elements.userInput.focus();
      }
    }

    function addMessage(text, sender, options = {}) {
      const { id = null, isError = false, hasCopy = false } = options;

      const messageElement = document.createElement('div');
      messageElement.classList.add('chat-message', `${sender}-message`);
      if (isError) messageElement.classList.add('error');
      if (id) messageElement.id = id;

      const textContainer = document.createElement('div');
      textContainer.className = 'message-text';

      if (sender === 'bot' && !id) {
        typewriterEffect(text, textContainer);
      } else {
        textContainer.innerHTML = text;
      }

      messageElement.appendChild(textContainer);

      if (hasCopy) {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.title = 'Copy Translation';
        copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(text);
          copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
            copyBtn.classList.remove('copied');
          }, 1500);
        });
        messageElement.appendChild(copyBtn);
      }

      elements.messageList.appendChild(messageElement);
      elements.messageList.scrollTop = elements.messageList.scrollHeight;
    }

    function typewriterEffect(text, container) {
      text.split('').forEach((char, index) => {
        const span = document.createElement('span');
        span.textContent = char;
        span.className = 'typewriter-char';
        span.style.animationDelay = `${index * 0.02}s`;
        container.appendChild(span);
      });
    }
  </script>
</body>

</html>
